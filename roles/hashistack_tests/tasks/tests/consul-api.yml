---
- name: "tests | consul-api | Define required variables for this test"
  ansible.builtin.set_fact:
    _hashistack_tests_required_variables:
      - hashistack_tests_consul_api_addr
      # can be set to empty string if not using ACLs
      - hashistack_tests_consul_token
      # can be set to localhost if api is reachable,
      # or to the address of a consul server if api is not reachable from localhost
      - hashistack_tests_consul_api_calls_delegation
      - hashistack_tests_consul_member_count

- name: "tests | consul-api | Assert required variables are set"
  ansible.builtin.assert:
    that:
      - item is defined
    fail_msg: "Required variable '{{ item }}' is not defined."
  loop: "{{ _hashistack_tests_required_variables }}"

- name: "tests | consul-api | Consul api"
  block:
    - name: "tests | consul-api | Get consul members"
      ansible.builtin.uri:
        url: "{{ hashistack_tests_consul_api_addr }}/v1/agent/members"
        method: GET
        headers: >-
          {{ {'X-Consul-Token': hashistack_tests_consul_token} if hashistack_tests_consul_token | length > 0 else omit }}
        status_code: 200
        return_content: true
      delegate_to: "{{ hashistack_tests_consul_api_calls_delegation }}"
      register: _hashistack_tests_consul_members

    - name: "tests | consul-api | Verify consul members"
      ansible.builtin.assert:
        that:
          - _hashistack_tests_consul_members.status == 200
          - (_hashistack_tests_consul_members.json | length | int) == hashistack_tests_consul_member_count | int
          - >-
            (_hashistack_tests_consul_members.json | selectattr('Status', 'equalto', 1)| list | length | int)
            == hashistack_tests_consul_member_count | int
