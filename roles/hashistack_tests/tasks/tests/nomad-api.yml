---
- name: "tests | nomad-api | Define required variables for this test"
  ansible.builtin.set_fact:
    _hashistack_tests_required_variables:
      - hashistack_tests_nomad_api_addr
      # can be set to empty string if not using ACLs
      - hashistack_tests_nomad_token
      # can be set to localhost if api is reachable,
      # or to the address of a consul server if api is not reachable from localhost
      - hashistack_tests_nomad_api_calls_delegation
      - hashistack_tests_nomad_server_count

- name: "tests | nomad-api | Assert required variables are set"
  ansible.builtin.assert:
    that:
      - item is defined
    fail_msg: "Required variable '{{ item }}' is not defined."
  loop: "{{ _hashistack_tests_required_variables }}"

- name: "tests | nomad-api | Nomad api"
  block:
    - name: "tests | nomad-api | Put variable"
      ansible.builtin.uri:
        url: "{{ hashistack_tests_nomad_api_addr }}/v1/var/secret/foobar"
        method: PUT
        headers:
          X-Nomad-Token: "{{ hashistack_tests_nomad_token | default(omit) }}"
        body_format: json
        body:
          Items:
            foo: "bar"
        status_code: 200
        return_content: true
      delegate_to: "{{ hashistack_tests_nomad_api_calls_delegation }}"
      register: _hashistack_tests_nomad_var_put

    - name: "tests | nomad-api | Get variable"
      ansible.builtin.uri:
        url: "{{ hashistack_tests_nomad_api_addr }}/v1/var/secret/foobar"
        method: GET
        headers:
          X-Nomad-Token: "{{ hashistack_tests_nomad_token | default(omit) }}"
        status_code: 200
        return_content: true
      delegate_to: "{{ hashistack_tests_nomad_api_calls_delegation }}"
      register: _hashistack_tests_nomad_var_get

    - name: "tests | nomad-api | Purge variable"
      ansible.builtin.uri:
        url: "{{ hashistack_tests_nomad_api_addr }}/v1/var/secret/foobar"
        method: DELETE
        headers:
          X-Nomad-Token: "{{ hashistack_tests_nomad_token | default(omit) }}"
        status_code: 204
        return_content: true
      delegate_to: "{{ hashistack_tests_nomad_api_calls_delegation }}"
      register: _hashistack_tests_nomad_var_purge

    - name: "tests | nomad-api | Get server members"
      ansible.builtin.uri:
        url: "{{ hashistack_tests_nomad_api_addr }}/v1/status/peers"
        method: GET
        headers:
          X-Nomad-Token: "{{ hashistack_tests_nomad_token | default(omit) }}"
        status_code: 200
        return_content: true
      delegate_to: "{{ hashistack_tests_nomad_api_calls_delegation }}"
      register: _hashistack_tests_nomad_status_peers

    - name: "tests | nomad-api | Verify API responses"
      ansible.builtin.assert:
        that:
          - _hashistack_tests_nomad_var_put.status == 200
          - _hashistack_tests_nomad_var_get.status == 200
          - _hashistack_tests_nomad_var_purge.status == 204
          - _hashistack_tests_nomad_status_peers.status == 200
          - _hashistack_tests_nomad_var_get.json.Items.foo == "bar"
          - (_hashistack_tests_nomad_status_peers.json | length | int) == hashistack_tests_nomad_server_count | int
