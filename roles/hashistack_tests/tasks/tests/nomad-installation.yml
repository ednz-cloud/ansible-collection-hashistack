---
- name: "tests | nomad-installation | Define required variables for this test"
  ansible.builtin.set_fact:
    _hashistack_tests_required_variables:
      - hashistack_tests_nomad_config_directory
      - hashistack_tests_nomad_data_directory
      - hashistack_tests_nomad_user
      - hashistack_tests_nomad_group
      - hashistack_tests_nomad_bin_path
      - hashistack_tests_nomad_service_name

- name: "tests | nomad-installation | Assert required variables are set"
  ansible.builtin.assert:
    that:
      - item is defined
    fail_msg: "Required variable '{{ item }}' is not defined."
  loop: "{{ _hashistack_tests_required_variables }}"

- name: "tests | nomad-installation | Nomad user and group"
  block:
    - name: "tests | nomad-installation | Getent user {{ hashistack_tests_nomad_user }}"
      ansible.builtin.getent:
        database: passwd
        key: "{{ hashistack_tests_nomad_user }}"
      register: _hashistack_tests_nomad_user

    - name: "tests | nomad-installation | Getent group {{ hashistack_tests_nomad_group }}"
      ansible.builtin.getent:
        database: group
        key: "{{ hashistack_tests_nomad_group }}"
      register: _hashistack_tests_nomad_group

    - name: "tests | nomad-installation | Verify nomad user and group"
      ansible.builtin.assert:
        that:
          - not _hashistack_tests_nomad_user.failed
          - not _hashistack_tests_nomad_group.failed
          - "hashistack_tests_nomad_user in _hashistack_tests_nomad_user.ansible_facts.getent_passwd.keys()"
          - "'/bin/false' in _hashistack_tests_nomad_user.ansible_facts.getent_passwd[hashistack_tests_nomad_user]"
          - "hashistack_tests_nomad_group in _hashistack_tests_nomad_group.ansible_facts.getent_group.keys()"

- name: "tests | nomad-installation | Binary {{ hashistack_tests_nomad_bin_path }}"
  block:
    - name: "tests | nomad-installation | Stat binary {{ hashistack_tests_nomad_bin_path }}"
      ansible.builtin.stat:
        path: "{{ hashistack_tests_nomad_bin_path }}"
      register: _hashistack_tests_stat_usr_local_bin_nomad

    - name: "tests | nomad-installation | Verify binary {{ hashistack_tests_nomad_bin_path }}"
      ansible.builtin.assert:
        that:
          - _hashistack_tests_stat_usr_local_bin_nomad.stat.exists
          - _hashistack_tests_stat_usr_local_bin_nomad.stat.isreg
          - _hashistack_tests_stat_usr_local_bin_nomad.stat.pw_name == 'root'
          - _hashistack_tests_stat_usr_local_bin_nomad.stat.gr_name == 'root'
          - _hashistack_tests_stat_usr_local_bin_nomad.stat.mode == '0755'

- name: "tests | nomad-installation | Directory {{ hashistack_tests_nomad_config_directory }}"
  block:
    - name: "tests | nomad-installation | Stat directory {{ hashistack_tests_nomad_config_directory }}"
      ansible.builtin.stat:
        path: "{{ hashistack_tests_nomad_config_directory }}"
      register: _hashistack_tests_stat_etc_nomad_d

    - name: "tests | nomad-installation | Stat file nomad.env"
      ansible.builtin.stat:
        path: "{{ hashistack_tests_nomad_config_directory }}/nomad.env"
      register: _hashistack_tests_stat_etc_nomad_d_nomad_env

    - name: "tests | nomad-installation | Stat file nomad.json"
      ansible.builtin.stat:
        path: "{{ hashistack_tests_nomad_config_directory }}/nomad.json"
      register: _hashistack_tests_stat_etc_nomad_d_nomad_json

    - name: "tests | nomad-installation | Slurp file nomad.json"
      ansible.builtin.slurp:
        src: "{{ hashistack_tests_nomad_config_directory }}/nomad.json"
      register: _hashistack_tests_slurp_etc_nomad_d_nomad_json

    - name: "tests | nomad-installation | Verify directory {{ hashistack_tests_nomad_config_directory }}"
      ansible.builtin.assert:
        that:
          - _hashistack_tests_stat_etc_nomad_d.stat.exists
          - _hashistack_tests_stat_etc_nomad_d.stat.isdir
          - _hashistack_tests_stat_etc_nomad_d.stat.pw_name == hashistack_tests_nomad_user
          - _hashistack_tests_stat_etc_nomad_d.stat.gr_name == hashistack_tests_nomad_group
          - _hashistack_tests_stat_etc_nomad_d.stat.mode == '0755'
          - _hashistack_tests_stat_etc_nomad_d_nomad_env.stat.exists
          - _hashistack_tests_stat_etc_nomad_d_nomad_env.stat.isreg
          - _hashistack_tests_stat_etc_nomad_d_nomad_env.stat.pw_name == hashistack_tests_nomad_user
          - _hashistack_tests_stat_etc_nomad_d_nomad_env.stat.gr_name == hashistack_tests_nomad_group
          - _hashistack_tests_stat_etc_nomad_d_nomad_env.stat.mode == '0600'
          - _hashistack_tests_stat_etc_nomad_d_nomad_json.stat.exists
          - _hashistack_tests_stat_etc_nomad_d_nomad_json.stat.isreg
          - _hashistack_tests_stat_etc_nomad_d_nomad_json.stat.pw_name == hashistack_tests_nomad_user
          - _hashistack_tests_stat_etc_nomad_d_nomad_json.stat.gr_name == hashistack_tests_nomad_group
          - _hashistack_tests_stat_etc_nomad_d_nomad_json.stat.mode == '0600'
          - _hashistack_tests_slurp_etc_nomad_d_nomad_json.content != ''

- name: "tests | nomad-installation | Directory {{ hashistack_tests_nomad_data_directory }}"
  block:
    - name: "tests | nomad-installation | Stat directory {{ hashistack_tests_nomad_data_directory }}"
      ansible.builtin.stat:
        path: "{{ hashistack_tests_nomad_data_directory }}"
      register: _hashistack_tests_stat_opt_nomad

    - name: "tests | nomad-installation | Verify directory {{ hashistack_tests_nomad_data_directory }}"
      ansible.builtin.assert:
        that:
          - _hashistack_tests_stat_opt_nomad.stat.exists
          - _hashistack_tests_stat_opt_nomad.stat.isdir
          - _hashistack_tests_stat_opt_nomad.stat.pw_name == hashistack_tests_nomad_user
          - _hashistack_tests_stat_opt_nomad.stat.gr_name == hashistack_tests_nomad_group
          - _hashistack_tests_stat_opt_nomad.stat.mode == '0755'

- name: "tests | nomad-installation | Service {{ hashistack_tests_nomad_service_name }}"
  block:
    - name: "tests | nomad-installation | Get service {{ hashistack_tests_nomad_service_name }}"
      ansible.builtin.service_facts:

    - name: "tests | nomad-installation | Stat systemd unit file"
      ansible.builtin.stat:
        path: "/etc/systemd/system/{{ hashistack_tests_nomad_service_name }}.service"
      register: _hashistack_tests_stat_etc_systemd_system_nomad_service

    - name: "tests | nomad-installation | Slurp systemd unit file"
      ansible.builtin.slurp:
        src: "/etc/systemd/system/{{ hashistack_tests_nomad_service_name }}.service"
      register: _hashistack_tests_slurp_etc_systemd_system_nomad_service

    - name: "tests | nomad-installation | Verify service {{ hashistack_tests_nomad_service_name }}"
      ansible.builtin.assert:
        that:
          - _hashistack_tests_stat_etc_systemd_system_nomad_service.stat.exists
          - _hashistack_tests_stat_etc_systemd_system_nomad_service.stat.isreg
          - _hashistack_tests_stat_etc_systemd_system_nomad_service.stat.pw_name == 'root'
          - _hashistack_tests_stat_etc_systemd_system_nomad_service.stat.gr_name == 'root'
          - _hashistack_tests_stat_etc_systemd_system_nomad_service.stat.mode == '0644'
          - _hashistack_tests_slurp_etc_systemd_system_nomad_service.content != ''
          - ansible_facts.services[hashistack_tests_nomad_service_name~'.service'] is defined
          - ansible_facts.services[hashistack_tests_nomad_service_name~'.service']['source'] == 'systemd'
          - ansible_facts.services[hashistack_tests_nomad_service_name~'.service']['state'] == 'running'
          - ansible_facts.services[hashistack_tests_nomad_service_name~'.service']['status'] == 'enabled'
